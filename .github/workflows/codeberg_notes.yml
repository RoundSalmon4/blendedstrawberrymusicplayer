name: Sync Releases Notes to Codeberg

on:
  workflow_dispatch:  # Trigger manually

permissions:
  contents: read
  deployments: write

jobs:
  sync_release_notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get Releases from GitHub
        id: get_releases
        run: |
          all_releases=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases")
          echo "$all_releases" | jq -r '.[] | select(.prerelease == false) | .tag_name' > releases.txt

      - name: Process Releases
        run: |
          while IFS= read -r tag_name; do
            # Check if a release exists on Codeberg
            release_check=$(curl -s -H "Authorization: token ${{ secrets.CODEBERG_TOKEN }}" "https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases/tags/${tag_name}")
            
            echo "Checking if release for tag $tag_name exists in Codeberg..."

            if [[ $(echo "$release_check" | jq -r '.message') == "The target couldn't be found." ]]; then
              echo "Release for tag $tag_name does not exist. Skipping..."
              continue
            fi

            echo "Release for tag $tag_name found. Extracting release ID..."
            release_id=$(echo "$release_check" | jq -r '.id')

            if [ -z "$release_id" ] || [[ "$release_id" == "null" ]]; then
              echo "Error: Could not retrieve Release ID for $tag_name. Skipping..."
              continue
            fi

            echo "Updating release notes for tag: $tag_name with ID $release_id"

            # Prepare the actual release notes from the GitHub release
            actual_body=$(echo "$all_releases" | jq -r --arg tag_name "$tag_name" '.[] | select(.tag_name == $tag_name) | .body')
            if [ -z "$actual_body" ]; then
              echo "No release notes found for tag $tag_name. Skipping..."
              continue
            fi

            echo "Actual release notes: $actual_body"

            # Prepare the payload for the update
            update_data=$(jq -n --arg body "$actual_body" '{body: $body}')

            echo "Payload for update: $update_data"

            # Send the PATCH request to update the release using the release ID
            update_response=$(curl -s -X PATCH -H "Authorization: token ${{ secrets.CODEBERG_TOKEN }}" -H "Content-Type: application/json" -d "$update_data" "https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases/$release_id")

            # Log the update response for debugging
            echo "Update response for $tag_name: $update_response"
            error_message=$(echo "$update_response" | jq -r '.message // empty')
            if [[ -n $error_message ]]; then
              echo "Error response from Codeberg: $error_message"
            else
              echo "Successfully updated release notes for $tag_name."
            fi
          done < releases.txt
