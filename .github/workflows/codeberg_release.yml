name: Sync Releases to Codeberg

on:
  workflow_dispatch:  # Only run on manual trigger

permissions:
  contents: write
  issues: write
  pull-requests: write
  deployments: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository with full history
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Discard uncommitted changes
        run: |
          git reset --hard

      - name: Configure Git User
        run: |
          git config --global user.email "codebergsync.nzvel@simplelogin.com"
          git config --global user.name "RoundSalmon4"

      - name: Get All Tags
        id: get_tags
        run: |
          tags=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tags")
          if [ -z "$tags" ]; then
            echo "No tags found."
            exit 1
          fi

          most_recent_tag=$(echo "$tags" | jq -r '.[0].name // empty')
          echo "Most Recent Tag: $most_recent_tag"
          echo "most_recent_tag=$most_recent_tag" >> $GITHUB_ENV

      - name: Get Release Information for Most Recent Tag
        id: get_release_info
        run: |
          release_info=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ env.most_recent_tag }}")
          if [[ "$release_info" == *"Not Found"* ]]; then
            echo "Error: Release not found for tag ${env.most_recent_tag}."
            exit 1
          fi

          asset_list=$(echo "$release_info" | jq -r '.assets[].browser_download_url // empty')
          if [ -z "$asset_list" ]; then
            echo "No assets found for the tag ${env.most_recent_tag}."
            exit 0
          fi

          echo "$asset_list" > assets.txt  # Save asset URLs to a text file for the next step

      - name: Pull Changes from Codeberg
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
        run: |
          git remote add codeberg https://$CODEBERG_TOKEN@codeberg.org/unwanted9855/blended-strawberry.git || echo "Remote 'codeberg' already exists."

      - name: Download and Upload Assets
        run: |
          while IFS= read -r asset_url; do
            if [ -z "$asset_url" ]; then
              echo "Empty URL, skipping."
              continue
            fi

            asset_name=$(basename "$asset_url")
            echo "Downloading asset: $asset_name"
            if curl -L -O -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$asset_url"; then
              echo "$asset_name downloaded successfully."
              
              # Check if the release exists on Codeberg for the current tag
              release=$(curl -s -H "Authorization: token ${{ secrets.CODEBERG_TOKEN }}" "https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases/tags/${{ env.most_recent_tag }}")
              if [[ "$release" == *"Not Found"* ]]; then
                # Create a new release if it does not exist
                echo "Creating release for tag ${env.most_recent_tag}."
                release_data="{\"tag_name\":\"${{ env.most_recent_tag }}\",\"name\":\"Release ${{ env.most_recent_tag }}\",\"body\":\"Release for tag ${{ env.most_recent_tag }}\"}"
                release_response=$(curl -s -X POST -H "Authorization: token ${{ secrets.CODEBERG_TOKEN }}" -H "Content-Type: application/json" -d "$release_data" "https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases")
                
                echo "Release creation response: $release_response" # Log the response

                # Check if release creation was successful
                if [[ "$release_response" == *"\"id\":"* ]]; then
                  echo "Release created successfully."
                else
                  echo "Failed to create release. Exiting."
                  exit 1
                fi
              else
                echo "Release already exists for tag ${env.most_recent_tag}."
              fi

              # Get the upload URL from the release response (assuming it's part of the release creation response)
              upload_url="https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases/assets?name=$asset_name"
              
              echo "Uploading asset $asset_name to release for tag ${{ env.most_recent_tag }}."
              if ! curl -s -X POST -H "Authorization: token ${{ secrets.CODEBERG_TOKEN }}" -H "Content-Type: $(file -b --mime-type "$asset_name")" --data-binary @"$asset_name" "$upload_url"; then
                echo "Failed to upload $asset_name. Exiting."
                exit 1
              fi
            else
              echo "Failed to download $asset_name. Exiting."
              exit 1
            fi

            # Pause briefly
            sleep 2
          done < assets.txt  # Read URLs from the generated file

