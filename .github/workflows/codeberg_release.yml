name: Sync Releases to Codeberg

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write  # Allows write access to repository contents
  issues: write    # Allows write access to issues (if needed)
  pull-requests: write  # Allows write access to pull requests (if needed)
  deployments: write  # Allows write access to deployments (if needed)

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository with full history
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Discard uncommitted changes
        run: |
          git reset --hard

      - name: Configure Git User
        run: |
          git config --global user.email "codebergsync.nzvel@simplelogin.com"
          git config --global user.name "RoundSalmon4"

      - name: Get All Tags
        id: get_tags
        run: |
          tags=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tags")
          echo "Tags Response: $tags"  # Debug: Check the response

          # Get the most recent tag
          most_recent_tag=$(echo "$tags" | jq -r '.[0].name // empty')
          if [ -z "$most_recent_tag" ]; then
            echo "No tags found."
            exit 0
          fi

          echo "Most Recent Tag: $most_recent_tag"
          echo "most_recent_tag=$most_recent_tag" >> $GITHUB_ENV

      - name: Get Release Information for Most Recent Tag
        run: |
          release_info=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ env.most_recent_tag }}")
          echo "Release Info Response: $release_info"  # Debug: Check the response

          # Check for errors
          if [[ "$release_info" == *"Not Found"* ]]; then
            echo "Error: Release not found for tag ${TAG}."
            exit 1
          fi

          # Extract asset URLs using browser_download_url
          asset_list=$(echo "$release_info" | jq -r '.assets[].browser_download_url // empty')
          if [ -z "$asset_list" ]; then
            echo "No assets found for the tag ${most_recent_tag}."
            exit 0
          fi

          # Download each asset
          echo "$asset_list" | while read -r asset_url; do
            asset_name=$(basename "$asset_url")
            echo "Downloading asset: $asset_name"
            curl -L -O -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$asset_url"
          done


      - name: Add Downloaded Files to Git
        run: |
          git add .

      - name: Pull Changes from Codeberg
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
        run: |
          git remote add codeberg https://$CODEBERG_TOKEN@codeberg.org/unwanted9855/blended-strawberry.git
          git fetch codeberg
          git merge codeberg/master --allow-unrelated-histories || true

      - name: Force Push to Codeberg
        run: |
          git push --force codeberg master
