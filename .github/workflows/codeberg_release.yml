name: Sync Releases to Codeberg

on:
  workflow_dispatch:  # Only run on manual trigger

permissions:
  contents: write
  issues: write
  pull-requests: write
  deployments: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository with full history
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Discard uncommitted changes
        run: |
          git reset --hard

      - name: Configure Git User
        run: |
          git config --global user.email "codebergsync.nzvel@simplelogin.com"
          git config --global user.name "RoundSalmon4"

      - name: Create New Branch
        id: create_branch
        run: |
          branch_name="upload-assets-${{ github.run_id }}"
          git checkout -b "$branch_name"
          echo "Created branch $branch_name"

      - name: Create Release
        id: create_release
        run: |
          # Getting the most recent tag from GitHub
          tags=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tags")
          most_recent_tag=$(echo "$tags" | jq -r '.[0].name // empty')
          echo "Using GitHub tag: $most_recent_tag"

          # Create a new release using the most recent tag
          release_data="{\"tag_name\":\"$most_recent_tag\",\"name\":\"$most_recent_tag\",\"body\":\"Release for tag $most_recent_tag\"}"
          echo "Release Data: $release_data"

          release_response=$(curl -s -X POST -H "Authorization: token ${{ secrets.CODEBERG_TOKEN }}" -H "Content-Type: application/json" -d "$release_data" "https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases")
          
          echo "Release API Response: $release_response"

          if [[ "$release_response" != *"\"id\":"* ]]; then
            echo "Failed to create release. Response: $release_response"
            exit 1
          fi

          echo "Release created successfully."

          # Extract asset download URLs (modify according to your assets)
          echo "https://example.com/asset1.zip" >> assets.txt
          echo "https://example.com/asset2.zip" >> assets.txt
          echo "https://example.com/asset3.zip" >> assets.txt
          echo "assets.txt created with asset URLs."

      - name: Download and Upload Assets
        run: |
          while IFS= read -r asset_url; do
            if [ -z "$asset_url" ]; then
              echo "Empty URL, skipping."
              continue
            fi

            asset_name=$(basename "$asset_url")
            echo "Downloading asset: $asset_name"
            if ! curl -L -O -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$asset_url"; then
              echo "Failed to download $asset_name. Exiting."
              exit 1
            fi
            echo "$asset_name downloaded successfully."

            # Upload the asset to the release
            upload_url="https://codeberg.org/api/v1/repos/unwanted9855/blended-strawberry/releases/assets?name=$(basename "$asset_name")"
            echo "Uploading asset $asset_name."
            if ! curl -s -X POST -H "Authorization: token ${{ secrets.CODEBERG_TOKEN }}" -H "Content-Type: $(file -b --mime-type "$asset_name")" --data-binary @"$asset_name" "$upload_url"; then
              echo "Failed to upload $asset_name to Codeberg. Exiting."
              exit 1
            fi
            echo "$asset_name uploaded successfully."

          done < assets.txt  # Read URLs from the generated file

      - name: Merge Back to Master
        run: |
          git checkout master
          git merge "$branch_name"
          git push codeberg master
